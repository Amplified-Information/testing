// Use lower_snake_case for field names (Google Protobuf Style Guide)
// Use json_name option for precise JSON serde - use protojson to Marshal/Unmarshal
syntax = "proto3";

package api;

option go_package = "api/gen;api";

import "validate/validate.proto"; // PGV
// import "google/protobuf/wrappers.proto"; // this is installed in protoc include path `ls /usr/include/google/protobuf/`

service ApiService {
  rpc Health(Empty) returns (StdResponse);
  rpc PredictIntent(PredictionIntentRequest) returns (StdResponse);
  rpc GetMarketById(MarketIdRequest) returns (MarketResponse);
  rpc GetMarkets(LimitOffsetRequest) returns (MarketsResponse);
  rpc CreateMarket(NewMarketRequest) returns (MarketResponse);
  rpc PriceHistory(PriceRequest) returns (PriceHistoryResponse);
  rpc AvailableNetworks(Empty) returns (StdResponse);
  // rpc CancelPosition ticket#6
  // rpc UserPositions ticket#7
  // rpc AddComment ticket#27
  // rpc ViewComments ticket#27
}

message Empty {}

message PredictionIntentRequest {
  string tx_id = 1        [json_name = "txId",        (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2          [json_name = "net",         (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  string market_id = 3    [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string generated_at = 4 [json_name = "generatedAt", (validate.rules).string = {pattern: "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])T([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d\\.\\d{3}Z$"} /* UTC ISO 8601 (Zulu time only) */];
  string account_id = 5   [json_name = "accountId",   (validate.rules).string = {pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"} /* Hedera account ID (no leading zeros) */];
  string market_limit = 6 [json_name = "marketLimit", (validate.rules).string = {in: ["market", "limit"]} /* still have 15 digits of decimal precision between 0.0 and 1.0 */];
  double price_usd = 7    [json_name = "priceUsd",    (validate.rules).double = {gt: -1.0, lt: 1.0} /* price_usd <0 => sell, price_usd >=0 => buy */];
  double qty = 8          [json_name = "qty",         (validate.rules).double = {gt: 0.0}];
  string sig = 9          [json_name = "sig",         (validate.rules).string = {pattern: "^[A-Za-z0-9+/]{20,100}={0,2}$"} /* base64-encoded signature (URL-safe base64 without padding, min 20 chars, max 100 chars) */];
  // passing extra key info - i) avoid lookups ii) handle situation where user has changed their key
  string public_key = 10  [json_name = "publicKey", (validate.rules).string = {pattern: "^(04|03|02)[0-9a-fA-F]{32,256}$"} /* uncompressed (04...) or compressed (02... or 03...) public key (ed25519, ecdsa, etc.) in hex format */];
  string evm_address = 11 [json_name = "evmAddress",  (validate.rules).string = {pattern: "^[0-9a-fA-F]{40}$"} /* 20-byte (40 hex chars) EVM address (no 0x prefix) */];
  uint32 key_type = 12    [json_name = "keyType",     (validate.rules).uint32 = {in: [1, 2]} /* 1 = ed25519, 2 = ecdsa_secp256k1 */];
}

message StdResponse {
  string message = 1;
  int32 errorCode = 2;
}

message MarketIdRequest {
  string market_id = 1 [json_name = "marketId",     (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2       [json_name = "net",          (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
}

message LimitOffsetRequest {
  int32 limit = 1  [(validate.rules).int32 = {gt: 0}];
  int32 offset = 2 [(validate.rules).int32 = {gt: 0}];
}

message MarketResponse {
  string market_id = 1    [json_name = "marketId"];
  string net = 2          [json_name = "net"];
  string statement = 3    [json_name = "statement"];
  bool is_open = 4        [json_name = "isOpen"];
  string created_at = 5   [json_name = "createdAt"];
  string resolved_at = 6  [json_name = "resolvedAt"];
}

message MarketsResponse {
  repeated MarketResponse markets = 1;
}

message NewMarketRequest {
  string market_id = 1    [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2          [json_name = "net",         (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  string statement = 3    [json_name = "statement", (validate.rules).string = {min_len: 10, max_len: 500}];
}

message PriceRequest {
  string market_id = 1 [json_name = "marketId", (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2       [json_name = "net",      (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  int32 offset = 3     [json_name = "offset",    (validate.rules).int32 = {gte: 0} /* offset in ticks */];
  int32 limit = 4      [json_name = "limit",     (validate.rules).int32 = {gt: 0, lte: 1000} /* max 1000 ticks per request */];
  string zoom = 5      [json_name = "zoom",      (validate.rules).string = {in: ["1m", "5m", "15m", "30m", "1h", "6h", "12h", "1d"]} /* zoom levels: 1 minute, 5 minutes, 15 minutes, 30 minutes, 1 hour, 6 hours, 12 hours, 1 day */];
}

message PriceHistoryResponse {
  repeated float ticks = 1;
  string from = 2 [json_name = "from"];
}
