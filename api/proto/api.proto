// Use lower_snake_case for field names (Google Protobuf Style Guide)
// Use json_name option for precise JSON serde - use protojson to Marshal/Unmarshal
syntax = "proto3";

package api;
option go_package = "api/gen;api";  // Golang requires this!

import "validate/validate.proto"; // PGV
// import "google/protobuf/wrappers.proto"; // this is installed in protoc include path `ls /usr/include/google/protobuf/`
// import "clob.proto";

service ApiServicePublic {
  rpc Health(Empty) returns (StdResponse);
  rpc NewsLetter(NewsLetterRequest) returns (StdResponse);
  rpc CreatePredictionIntent(PredictionIntentRequest) returns (StdResponse);
  rpc GetMarketById(MarketIdRequest) returns (MarketResponse);
  rpc GetMarkets(LimitOffsetRequest) returns (MarketsResponse);
  rpc CreateMarket(CreateMarketRequest) returns (CreateMarketResponse);
  rpc PriceHistory(PriceHistoryRequest) returns (PriceHistoryResponse);
  rpc MacroMetadata(Empty) returns (MacroMetadataResponse); // general market data - volume, nMarkets, TVL, liquidity, etc.
  rpc CreateComment(CreateCommentRequest) returns (CreateCommentResponse);
  rpc GetComments(GetCommentsRequest) returns (GetCommentsResponse);
  rpc GetUserPortfolio(UserPortfolioRequest) returns (UserPortfolioResponse);
  rpc CancelPredictionIntent(CancelOrderRequest) returns (StdResponse);
}

service ApiServiceInternal {
  // rpc endpoints go here
  rpc TriggerRecreateClob(Empty) returns (StdResponse);
  // rpc DeleteMarket(MarketIdRequest) returns (StdResponse); // systematically delete a market
}

message Empty {}

message PredictionIntentRequest {
  string tx_id = 1              [json_name = "txId",        (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2                [json_name = "net",         (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  string market_id = 3          [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string generated_at = 4       [json_name = "generatedAt", (validate.rules).string = {pattern: "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])T([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d\\.\\d{3}Z$"} /* UTC ISO 8601 (Zulu time only) */];
  string account_id = 5         [json_name = "accountId",   (validate.rules).string = {pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"} /* Hedera account ID (no leading zeros) */];
  string market_limit = 6       [json_name = "marketLimit", (validate.rules).string = {in: ["market", "limit"]} /* still have 15 digits of decimal precision between 0.0 and 1.0 */];
  double price_usd = 7          [json_name = "priceUsd",    (validate.rules).double = {gt: -1.0, lt: 1.0} /* price_usd <0 => sell, price_usd >=0 => buy */];
  double qty = 8                [json_name = "qty",         (validate.rules).double = {gt: 0.0}];
  string sig = 9                [json_name = "sig",         (validate.rules).string = {pattern: "^[A-Za-z0-9+/]{20,100}={0,2}$"} /* base64-encoded signature (URL-safe base64 without padding, min 20 chars, max 100 chars) */];
  // passing extra key info - i) avoid lookups ii) handle situation where user has changed their key
  string public_key = 10        [json_name = "publicKey", (validate.rules).string = {pattern: "^(04|03|02)[0-9a-fA-F]{32,256}$"} /* uncompressed (04...) or compressed (02... or 03...) public key (ed25519, ecdsa, etc.) in hex format */];
  string evm_address = 11       [json_name = "evmAddress",  (validate.rules).string = {pattern: "^[0-9a-fA-F]{40}$"} /* 20-byte (40 hex chars) EVM address (no 0x prefix) */];
  uint32 key_type = 12          [json_name = "keyType",     (validate.rules).uint32 = {in: [1, 2]} /* 1 = ed25519, 2 = ecdsa_secp256k1 */];
  // string smart_contract_id = 9  [json_name = "smartContractId"]; // not needed - smart_contract_id is a column in the markets table
}

message StdResponse {
  string message = 1     [json_name = "message"];
  int32 error_code = 2   [json_name = "errorCode"];
}

message MacroMetadataResponse {
  repeated string available_networks = 1      [json_name = "availableNetworks"];
  map<string, string> smart_contract_ids = 2  [json_name = "smartContractIds"];
  map<string, string> usdc_token_ids = 3      [json_name = "usdcTokenIds"];
  uint32 usdc_decimals = 4                    [json_name = "usdcDecimals"];
  uint64 market_creation_fee_scaled_usdc = 5  [json_name = "marketCreationFeeScaledUsdc"];
  uint32 n_markets = 6                        [json_name = "nMarkets"];
  map<string, string> token_ids = 7           [json_name = "tokenIds"];
  double min_order_size_usd = 8               [json_name = "minOrderSizeUsd"];
  double tvl_usd = 9                          [json_name = "tvlUsd"];
  map<string, double> total_volume_usd = 10   [json_name = "totalVolumeUsd"];
}

message NewsLetterRequest {
  string email = 1 [json_name = "email", (validate.rules).string = {email: true}];
}

message UserPortfolioRequest {
  string evm_address = 1           [json_name = "evmAddress",  (validate.rules).string = {pattern: "^[0-9a-fA-F]{40}$"} /* 20-byte (40 hex chars) EVM address (no 0x prefix) */];
  string net = 2                   [json_name = "net",         (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  optional string market_id = 3    [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
}
message Position {
  uint64 yes = 1              [json_name = "yes"];
  uint64 no = 2               [json_name = "no"];
  float price_usd = 3         [json_name = "priceUsd"];
  bool is_paused = 4          [json_name = "isPaused"];
  string resolved_at = 5      [json_name = "resolvedAt"];
}
message UserPortfolioResponse {
  map<string, Position> positions = 1   [json_name = "positions"];
  map<string, Position> orderbook_positions = 2   [json_name = "orderbookPositions"];
}

message MarketIdRequest {
  string market_id = 1 [json_name = "marketId",     (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
}

message LimitOffsetRequest {
  int32 limit = 1  [(validate.rules).int32 = {gt: 0}];
  int32 offset = 2 [(validate.rules).int32 = {gt: 0}];
}

message MarketResponse {
  string market_id = 1          [json_name = "marketId"];
  string net = 2                [json_name = "net"];
  string statement = 3          [json_name = "statement"];
  bool is_paused = 4            [json_name = "isPaused"];
  string created_at = 5         [json_name = "createdAt"];
  string resolved_at = 6        [json_name = "resolvedAt"];
  string image_url = 7          [json_name = "imageUrl"];
  float price_usd = 8           [json_name = "priceUsd"];
  // string smart_contract_id = 9  [json_name = "smartContractId"]; // not needed - smart_contract_id is a column in the markets table
}

message CreateMarketResponse {
  MarketResponse market_response = 1  [json_name = "marketResponse"]; 
  uint64 remaining_allowance = 2      [json_name = "remainingAllowance"];
}

message MarketsResponse {
  repeated MarketResponse markets = 1;
}

message CreateMarketRequest {
  string market_id = 1            [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2                  [json_name = "net",         (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  string statement = 3            [json_name = "statement",   (validate.rules).string = {min_len: 5, max_len: 500}];
  string image_url = 4            [json_name = "imageUrl",    (validate.rules).string = {uri: true, max_len: 2048}];
  //string smart_contract_id = 5; // not needed - smart_contract_id is added to the markets table at run-time based on the net
}

message PriceHistoryRequest {
  string market_id = 1    [json_name = "marketId", (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string net = 2          [json_name = "net",      (validate.rules).string = {in: ["mainnet", "testnet", "previewnet"]} /* Hedera network */];
  string resolution = 3   [json_name = "resolution",      (validate.rules).string = {in: ["second", "minute", "hour", "day", "week", "month", "quarter", "year", "decade"]} /* zoom levels: postgres truncation */];
  string from = 4         [json_name = "from", (validate.rules).string = {pattern: "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])T([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d\\.\\d{3}Z$"} /* UTC ISO 8601 (Zulu time only) */];
  string to = 5           [json_name = "to", (validate.rules).string = {pattern: "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])T([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d\\.\\d{3}Z$"} /* UTC ISO 8601 (Zulu time only) */];
  optional int32 limit = 6         [json_name = "limit",     (validate.rules).int32 = {gt: 0, lte: 1000} /* max 1000 ticks per request */];
  optional int32 offset = 7        [json_name = "offset",    (validate.rules).int32 = {gte: 0} /* offset in ticks */];
}

message PriceHistoryResponse { // want [timestampMs[], priceUsd[]] for graphing (e.g. uplot)
  repeated uint64 timestamp_ms = 1   [json_name = "timestampMs"];
  repeated float price_usd = 2       [json_name = "priceUsd"];
}

message GetCommentsRequest {
  string market_id = 1      [json_name = "marketId",  (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  optional int32 limit = 2  [json_name = "limit",     (validate.rules).int32 = {gt: 0, lte: 100} /* max 100 comments per request */];
  optional int32 offset = 3 [json_name = "offset",    (validate.rules).int32 = {gte: 0} /* offset in comments */];
}

message Comment {
  // string comment_id = 1    [json_name = "commentId"];
  string account_id = 1    [json_name = "accountId"];
  string content = 2       [json_name = "content"];
  string sig = 3           [json_name = "sig"];
  string public_key = 4    [json_name = "publicKey"];
  uint32 key_type = 5      [json_name = "keyType"];
  string created_at = 6    [json_name = "createdAt"];
}

message GetCommentsResponse {
  repeated Comment comments = 1;
}

message CreateCommentRequest {
  string market_id = 1    [json_name = "marketId",    (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string account_id = 2   [json_name = "accountId",   (validate.rules).string = {pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"} /* Hedera account ID (no leading zeros) */];
  string content = 3      [json_name = "content",     (validate.rules).string = {min_len: 1, max_len: 1000}];
  string sig = 4          [json_name = "sig",         (validate.rules).string = {pattern: "^[A-Za-z0-9+/]{20,100}={0,2}$"} /* base64-encoded signature (URL-safe base64 without padding, min 20 chars, max 100 chars) */];
  string public_key = 5   [json_name = "publicKey",   (validate.rules).string = {pattern: "^(04|03|02)[0-9a-fA-F]{32,256}$"} /* uncompressed (04...) or compressed (02... or 03...) public key (ed25519, ecdsa, etc.) in hex format */];
  uint32 key_type = 6     [json_name = "keyType",     (validate.rules).uint32 = {in: [1, 2]} /* 1 = ed25519, 2 = ecdsa_secp256k1 */];
}

message CreateCommentResponse {
  Comment comment = 1;
}

message ClobOrder {
  string market_id = 1;
  string tx_id = 2;
}


// message ClobOrders { // the API retrieves information from the db and returns it to the clob so it can recreate the orderbooks
//   repeated clob.CreateOrderRequestClob orders = 1;
// }

message CancelOrderRequest {
  string market_id = 1      [json_name = "marketId",  (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
  string tx_id = 2          [json_name = "txId",      (validate.rules).string = {pattern: "(?i)^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"} /* Strict RFC-9562-compliant UUIDv7 */];
}
